#!/bin/bash

# Set up DigitalOcean Droplet console & metrics agents
wget -qO- https://repos-droplet.digitalocean.com/install.sh | bash
curl -sSL https://repos.insights.digitalocean.com/install.sh | bash

# Install & start Tailscale
curl -fsSL https://tailscale.com/install.sh | sh

echo 'net.ipv4.ip_forward = 1' | tee -a /etc/sysctl.d/99-tailscale.conf
echo 'net.ipv6.conf.all.forwarding = 1' | tee -a /etc/sysctl.d/99-tailscale.conf
sysctl -p /etc/sysctl.d/99-tailscale.conf

tailscale up -authkey "${tailscale_token}" --accept-routes --advertise-exit-node

# Install & set up Caddy
mkdir /opt/caddy
pushd /opt/caddy

wget "https://i.bootleg.technology/caddy" -O caddy
chmod +x ./caddy

groupadd --system caddy
useradd --system \
    --gid caddy \
    --create-home \
    --home-dir /var/lib/caddy \
    --shell /usr/sbin/nologin \
    --comment "Caddy web server" \
    caddy

cat <<EOT >> caddy.json
${caddy_config}
EOT

chown -R caddy:caddy .

cat <<EOT >> /etc/systemd/system/caddy.service
[Unit]
Description=Caddy
Documentation=https://caddyserver.com/docs/
After=network.target network-online.target
Requires=network-online.target

[Service]
Type=notify
User=caddy
Group=caddy
ExecStart=/opt/caddy/caddy run --environ --config /opt/caddy/caddy.json
ExecReload=/opt/caddy/caddy reload --config /opt/caddy/caddy.json --force
TimeoutStopSec=5s
LimitNOFILE=1048576
LimitNPROC=512
PrivateTmp=true
ProtectSystem=full
AmbientCapabilities=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
EOT

popd
systemctl daemon-reload
systemctl enable --now caddy
